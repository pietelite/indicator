plugins {
    id 'org.cadixdev.licenser' version '0.6.1' apply false
}

defaultTasks 'updateLicensesMain', 'build'

static def patchVersion() {
    // TODO enable once a proper tag has been loaded
//    def tagInfo = 'git describe --tags'.execute().text.trim()
//    if (!tagInfo.contains('-')) {
//        return 0
//    }
//    return tagInfo.split("-")[1]
    return '0'
}

static def suffix() {
    // TODO enable once a proper tag has been loaded
//    def journeyEnv = System.getenv('JOURNEY_ENV')
//    if (journeyEnv == null || journeyEnv != 'PROD') {
//        return '-dev-' + 'git rev-parse --short HEAD'.execute().text.trim()
//    }
    return ''
}


subprojects {
    apply plugin: 'java'
    apply plugin: 'org.cadixdev.licenser'

    project.ext.publish = false
    project.ext.snapshot = true

    project.ext.majorVersion = '1'
    project.ext.minorVersion = '0'
    project.ext.patchVersion = patchVersion()

    project.ext.snapshotVersion = project.ext.snapshot ? "-SNAPSHOT" : ""
    project.ext.apiVersion = project.ext.majorVersion + '.' + project.ext.minorVersion
    project.ext.apiFullVersion = project.ext.apiVersion + project.ext.snapshotVersion
    project.ext.fullVersion = project.ext.apiVersion + '.' + project.ext.patchVersion + suffix()
    version = project.ext.fullVersion
    group = 'net.whimxiqal.journey'

    sourceCompatibility = 16
    targetCompatibility = 16

    tasks.withType(JavaCompile) {
        options.encoding = 'UTF-8'
    }

    jar {
        from '../LICENSE.txt'
    }

    license {
        ignoreFailures = true
        header = rootProject.file('LICENSE.txt')
        include '**/*.java'
        newLine = true
    }

    repositories {
        mavenCentral()
        maven {
            name = 'sonatype-snapshots'
            url = 'https://s01.oss.sonatype.org/content/repositories/snapshots/'
        }
    }

    test {
        useJUnitPlatform()
    }
}